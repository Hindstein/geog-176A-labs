---
title: "GEOG 176A: Intro to GIS"
author: "[Ian Hinds](https://hindstein.github.io/GEOG176A/)"
subtitle: 'Lab 04: Tesselations, Point-in-polygon'
date: "31 August 2020"
output:
  html_document:
    theme: journal
---
## Background
In this lab we will an explore the impacts of tessellated surfaces and the modifiable areal unit problem (MAUP) using the National Dam Inventory maintained by the United States Army Corps of Engineers. Doing this will require repetitive tasks that we will write as functions and careful consideration of feature aggregation/simplification, spatial joins, and data visualization. The end goal is to visualize the distribution of dams and there purposes across the country.

*****

## Libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(sf)
library(USAboundaries)
library(tidyverse)
library(rmapshaper)
```
*****
## Quesion 1: 
Prepare five tessellated surfaces from CONUS and write a function to plot them in a descriptive way.

### *Step 1.1 (CONUS Counties Spatial File)*
* get an sf object of US counties (USAboundaries::us_counties())
* remove those not in CONUS
* transform the data to EPSG:5070
```{r}
counties = USAboundaries::us_counties() %>%
  filter(!state_name %in% c("Hawaii",
                            "Alaska",
                            "Puerto Rico",
                            "Guam")) %>%
  st_as_sf(coords = c("lng", "lat"), crs = 4326) %>%
  st_transform(5070)
```

### *Step 1.2 (Anchor Points for Triangle Tessellation)*
- generate county centroids using st_centroid
- combine POINT features into a single MULTIPOINT feature
- the difference between union/combine is mute
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
countycent = st_centroid(counties) 
countycent_c = st_combine(countycent)
```

### *Step 1.3 (Tile Shapes and Types)*
- Make a voroni tessellation over your county centroids (MULTIPOINT)
- Make a triangulated tessellation over your county centroids (MULTIPOINT)
- Make a gridded coverage with n = 70, over your counties object
- Make a hexagonal coverage with n = 70, over your counties object
- Add a new column to each tessellation that spans from 1:n().
- Coerse the sfc list into an sf object (st_sf or st_as_sf)
- Ensure that our surfaces are topologically valid/simple (pass our surfaces through st_cast)

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# voroni tessellation
v_grid = st_voronoi(countycent_c) %>%
  st_cast() %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

# triangulated tesselation
tri_grid = st_triangulate(countycent_c) %>%
  st_cast() %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

# square (grid) tesselation
sqgrid = st_make_grid(counties, n=70) %>%
  st_cast() %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

# hexagonal tessellation
hexgrid = st_make_grid(counties, n=70, square=FALSE) %>%
  st_cast() %>%
  st_as_sf() %>%
  mutate(id = 1:n())
```

### *Step 1.4 (Plot Examples of Tessellations and Trim)*
- Plot all defined grids and cut regional boundaries to CONUS border

```{r}
# Voroni Grid
plot(v_grid)

# Triangulated Grid
plot(tri_grid)

# Sqaure Grid
plot(sqgrid)

# Hexagonal Grid
plot(hexgrid)

# Cut county boundaries to CONUS border
countybound1 = st_filter(counties, tri_grid, .predicate = st_intersects) 

```

###*Step 1.5 (Simplify Geometry Points)*
- Use the Visvalingam algotithm provided by rmapshaper::ms_simplify.
- Choose what percentage of vertices to retain using the keep argument
- Use the mapview::npts function to report the number of points in the original object, and in the simplified object.
- How many points were you able to remove? What are the consequences of doing this computationally?
- Use your simplified object to crop the two triangulated tessellations with st_intersection:
```{r message=FALSE, warning=FALSE}
# ms_simplify, keep 5% of points
#countybound5 = ms_simplify(countybound1, keep = .05)

countybound2 = st_filter(counties, tri_grid, .predicate = st_intersects) %>%
  ms_simplify(keep = .05) %>%
  plot(max.plot = 1)

countyboundv = st_filter(counties, v_grid, .predicate = st_intersects) %>%
  ms_simplify(keep = .05) 

#mapview::npts(countyboundtri)
#22416/51976 original triangulated points 

```
###*Step 1.6 (Plot Tessellations Using a function)*
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
plot_pip = function(data, var){
  ggplot() +
    geom_sf(data = data, aes(color = "white"), size = .2) +
    scale_color_gradient(low = "white", high = "navy") +
    theme_void() +
    theme(legend.position = "bottom")
}

#plot_pip(counties, tri_grid) %>%
#  plot()
```

## Question 2:
write out a function to summarize our tessellated surfaces

### *Step 2.1 (Create a function that returns a data.frame)*

-The function name can be anything you chose, arg1 should take an sf object, and arg2 should take a character string describing the object
-calculate the area of arg1; convert the units to km2; and then drop the units
-create a data.frame containing the following:

### *Step 2.2*

### *Step 2.3*

### *Step 2.4*

### *Step 2.5*

## Question 3:
The data we are going to analysis in this lab is from US Army Corp of Engineers National Dam Inventory (NID). This dataset documents ~91,000 dams in the United States and a variety of attribute information including design specifications, risk level, age, and purpose.

For the remainder of this lab we will analysis the distributions of these dams (Q3) and their purpose (Q4) through using a point-in-polygon analysis.

### *Step 3.1*

### *Step 3.2*

### *Step 3.3*

### *Step 3.4*

### *Step 3.5*

### *Step 3.6*

## Question 4:


### *Step 4.1*

### *Step 4.2*

### *Step 4.3*

### *Step 4.3*

## Extra Credit:

