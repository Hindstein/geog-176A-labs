---
title: "GEOG 176A: Intro to GIS"
author: "[Ian Hinds](https://hindstein.github.io/GEOG176A/)"
subtitle: 'Lab 05: Rasters & Remote Sensing'
date: "4 September 2020"
output:
  html_document:
    theme: journal
---

******

## Background
On September 26, 2016 at 11:47 a.m. U.S. Central Daylight Time (16:47 UTC) the Cedar and Wapsipinicon rivers in Iowa surged producing a flood wave that breached the river banks. The water level of the Cedar River measured ~20 feet — 8 feet above flood stage—near the city of Cedar Rapids.

The water level continued to rise until it peaked at ~22 feet on September 27. This event had only been exceeded once, in June 2008, when thousands of people were encouraged to evacuate from Cedar Rapids, the second-most-populous city in Iowa.

In this lab we are interested in the impacts in Palo Iowa because it is up stream of Cedar Rapids, contains a large amount of farm land, and does not have a forecast location to provide warning.

We will use the raster package and our understanding of raster data and categorization to create flood images using mutliband Landsat Imagery, thresholding, and classification methods.

### Libraries
```{r message=FALSE, warning=FALSE}
library(raster) # Raster Data handling
library(tidyverse) # Data Manipulation
library(getlandsat) # keyless Landsat data (2013-2017)
library(osmdata)
library(sf) # Vector data processing
library(mapview) # Rapid Interactive visualization
```

Remote Sensing/Image Analysis begins with usually the same steps:

- 1. Identifying an area of interest (AOI)
- 2. Identifying and downloading the relevant images or products
- 3. Analyzing the raster products

*****

## *Question 1 (AOI Definition)*

Using uscities.csv, filter to Palo, Iowa and create a 5 kilometer buffer.

- Read in the csv data
- Structure it as a spatial (sf) feature by defining the coordinate fields and CRS
- Filter to only include Palo, Iowa
- Transform the projection into a CRS appropriate for meter-based measurements

From the Palo, Iowa feature:

- generate a 5 kilometer (5,000 meter) buffer around the point using st_buffer
- find the bounding box of the buffered region using st_bbox
- Convert that bbox object into as sfc then sf object

This region defines the AOI for this analysis.
```{r}
bb = read.csv('../data/uscities.csv') %>%
  filter(city == "Palo") %>%
  st_as_sf(coords = c("lng", "lat"), crs = 4326) %>%
  st_transform(5070) %>%
  st_buffer(5000) %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_as_sf()
```

*****

## *Question 2 (Data Acquisition)*
### 2.1 (Retrieve Palo flood data)
For our analysis we will be using data from Landsat 8. Landsat 8 is the newest generation of the Landsat satellites and provides a useful resource for water detection. The OLI sensor aboard Landsat 8 has nine bands for capturing the spectral response of the earth’s surface at discrete wavelengths along the electromagnetic spectrum.

```{r message=FALSE, warning=FALSE}
#code is from lab05.R file
bbwgs = bb %>% st_transform(4326)
bb = st_bbox(bbwgs)

osm = osmdata::opq(bbwgs) %>%
  #or building
  add_osm_feature("natural") %>%
  osmdata_sf()

#mapview(osm$osm_polygons)

scenes = lsat_scenes()

down = scenes %>%
  filter(min_lat <= bb$ymin, max_lat >= bb$ymax,
         min_lon <= bb$xmin, max_lon >= bb$xmax,
         as.Date(acquisitionDate) == as.Date("2016-09-26"))

#write.csv(down, file = "data/palo-flood-scene.csv")
```



### 2.2 (Caching the Data)
We need to download and cache the data on our computers.

Caching essentially means we will download the data to a standardized location known to the downloading utility.

Before any data is downloaded, the utility will check if it already exisits. If it does, then the path to the file is returned, if it does not, the data is downloaded.
```{r message=FALSE, warning=FALSE}
meta = read_csv("../data/palo-flood-scene.csv")

files = lsat_scene_files(meta$download_url) %>%
  filter(grepl(paste0("B", 1:6, ".TIF$", collapse = "|"), file)) %>%
  arrange(file) %>%
  pull(file)

```


### 2.3 (Download sat files to cache)
Now that we have the URLs of the files we want, we need to download them to our cache location, using *getlandsat*

```{r message=FALSE, warning=FALSE}
st = sapply(files, lsat_image)

s = stack(st) %>% setNames(c(paste0("band", 1:6)))
s
```


### 2.4 (Crop Rasterstack *st* )
We only want to analyze our image for the regions surrounding Palo (our AOI). We will transform our AOI to the CRS of the landsat stack and use it to crop the raster stack.

```{r message=FALSE, warning=FALSE}
cropper = bbwgs %>%
  st_transform(crs(s))

r = crop(s, cropper)
r
```


*****

## *Question 3: (Image Creation)*
### 3.1 (Rename raster stack with RS Band names)


### 3.2 (Replicate Images)


The purpose of applying a color sketch is ....

*****

## *Question 4: (Thresholding)*
### 4.1 (Raster Algebra)


### 4.2 (Raster Thresholding)

*****

## *Question 5: (Classification)*
### 5.1 (Set a seed)

### 5.2 (*kmeans*)

### 5.3 (Table using *kmeans_raster*)

*****

## *Questions 6: (Summary)*
### 6.1 (Total Area)

### 6.2 (Summing the stack)

### 6.3 (Plot stack) 

*****

## Extra Credit: Pixel Evaluation



*****

